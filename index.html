<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£åœ°ç†å¤§å¯Œç¿ </title>
    <style>
        :root {
            --p1-color: #ff5252; /* ç´… */
            --p2-color: #2979ff; /* è— */
            --p3-color: #00e676; /* ç¶  */
            --p4-color: #ffea00; /* é»ƒ */
            --board-bg: #81d4fa;
            --cell-bg: #ffffff;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #e0f7fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        h1 { color: #006064; margin: 0 0 15px 0; font-size: 24px; }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        .game-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* --- æ£‹ç›¤å€ (CSS Grid) --- */
        #board {
            display: grid;
            grid-template-columns: repeat(6, 90px); /* 6è¡Œ */
            grid-template-rows: repeat(6, 90px);    /* 6åˆ— */
            gap: 6px;
            background-color: var(--board-bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .cell {
            background-color: var(--cell-bg);
            border: 1px solid #b0bec5;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 4px;
            position: relative;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* è²·ä¸‹å¾Œçš„æ¨£å¼ (é€é JS å‹•æ…‹ä¿®æ”¹ border) */
        .cell-owned {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .cell-name { font-weight: bold; margin-top: 5px; line-height: 1.2; }
        .cell-price { font-size: 11px; color: #666; margin-bottom: 2px; }
        
        /* ç‰¹æ®Šæ ¼å­é¡è‰² */
        .type-start { background-color: #ffccbc; }
        .type-chance { background-color: #ffe0b2; }
        .type-jail { background-color: #cfd8dc; }

        /* --- ç©å®¶æ£‹å­ --- */
        .players-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 3px;
            width: 100%;
            height: 20px;
        }
        .token {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* --- æ§åˆ¶é¢æ¿å€ --- */
        #controls {
            width: 280px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }

        /* ç©å®¶ç‹€æ…‹å¡ */
        .player-info {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 6px solid #ccc;
            background: #f5f5f5;
            transition: transform 0.2s;
        }
        
        .p1-stats { border-color: var(--p1-color); }
        .p2-stats { border-color: var(--p2-color); }
        .p3-stats { border-color: var(--p3-color); }
        .p4-stats { border-color: var(--p4-color); }

        .active-turn {
            background: #fffDE7;
            transform: scale(1.03);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-weight: bold;
        }

        .player-money { font-size: 16px; color: #333; }
        
        /* åœ°ç”¢åˆ—è¡¨æ–‡å­— */
        .land-list {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
            line-height: 1.4;
            min-height: 1.4em;
            word-wrap: break-word;
        }

        /* éª°å­èˆ‡è¨Šæ¯å€ */
        #dice-area {
            margin-top: auto;
            text-align: center;
            padding-top: 15px;
            border-top: 2px dashed #eee;
        }
        
        #dice-display {
            font-size: 48px;
            margin: 10px 0;
            min-height: 60px;
        }

        #dice-btn {
            background: linear-gradient(to bottom, #ff7043, #f4511e);
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 0 #d84315;
            transition: all 0.1s;
        }
        #dice-btn:active { transform: translateY(4px); box-shadow: none; }
        #dice-btn:disabled { background: #bdbdbd; box-shadow: none; cursor: not-allowed; }

        #message-log {
            margin-top: 15px;
            height: 120px;
            overflow-y: auto;
            background: #fafafa;
            border: 1px solid #eee;
            padding: 8px;
            font-size: 13px;
            border-radius: 5px;
            color: #444;
        }
        #message-log div { margin-bottom: 4px; border-bottom: 1px solid #f0f0f0; }

        /* --- å½ˆå‡ºè¦–çª— (Modal) --- */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        #quiz-box {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #modal-title { color: #00695c; margin-top: 0; }
        #modal-desc { margin-bottom: 20px; color: #555; font-size: 15px; }

        .option-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 2px solid #81d4fa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #0277bd;
            transition: background 0.2s;
        }
        .option-btn:hover { background: #e1f5fe; }
    </style>
</head>
<body>

    <h1>å°ç£èµ°é€é€ï¼šåœ°ç†å¤§å¯Œç¿</h1>

    <div class="game-wrapper">
        <div id="board"></div>

        <div id="controls">
            <div id="p1-info" class="player-info p1-stats">
                <div class="player-money">ç©å®¶1 (ç´…): $<span id="p1-money">20000</span></div>
                <div id="p1-lands" class="land-list">åœ°ç”¢: ç„¡</div>
            </div>
            <div id="p2-info" class="player-info p2-stats">
                <div class="player-money">ç©å®¶2 (è—): $<span id="p2-money">20000</span></div>
                <div id="p2-lands" class="land-list">åœ°ç”¢: ç„¡</div>
            </div>
            <div id="p3-info" class="player-info p3-stats">
                <div class="player-money">ç©å®¶3 (ç¶ ): $<span id="p3-money">20000</span></div>
                <div id="p3-lands" class="land-list">åœ°ç”¢: ç„¡</div>
            </div>
            <div id="p4-info" class="player-info p4-stats">
                <div class="player-money">ç©å®¶4 (é»ƒ): $<span id="p4-money">20000</span></div>
                <div id="p4-lands" class="land-list">åœ°ç”¢: ç„¡</div>
            </div>

            <div id="dice-area">
                <div id="dice-display">ğŸ²</div>
                <button id="dice-btn" onclick="rollDice()">æ“²éª°å­</button>
            </div>

            <div id="message-log">
                <div>æ­¡è¿ä¾†åˆ°å°ç£å¤§å¯Œç¿ï¼</div>
                <div>è«‹ç©å®¶1é–‹å§‹æ“²éª°å­ã€‚</div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="quiz-box">
            <h2 id="modal-title">æ¨™é¡Œ</h2>
            <p id="modal-desc">æè¿°æ–‡å­—</p>
            <div id="modal-options">
                </div>
        </div>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™ ---
    
    // åœ°åœ–é…ç½® (20æ ¼)
    // type: start, city, chance, jail
    const mapData = [
        { name: 'å°åŒ—(èµ·é»)', type: 'start', price: 0 },
        { name: 'æ–°åŒ—å¸‚', type: 'city', price: 2000, rent: 500, desc: 'äººå£æœ€å¤šï¼Œæœ‰è€¶èª•åŸ' },
        { name: 'æ¡ƒåœ’å¸‚', type: 'city', price: 1500, rent: 300, desc: 'åœ‹éš›æ©Ÿå ´ï¼Œä¹Ÿæ˜¯åƒå¡˜ä¹‹é„‰' },
        { name: 'æ–°ç«¹å¸‚', type: 'city', price: 1200, rent: 250, desc: 'å°ç£çŸ½è°·ï¼Œç‰¹ç”¢ç±³ç²‰è²¢ä¸¸' },
        { name: 'è‹—æ —ç¸£', type: 'city', price: 1000, rent: 200, desc: 'å±±åŸï¼Œæœ‰è‘—åçš„é¾é¨°æ–·æ©‹' },
        { name: 'å‘½é‹',    type: 'chance', price: 0 },
        { name: 'å°ä¸­å¸‚', type: 'city', price: 1800, rent: 400, desc: 'æ°£å€™å®œäººï¼Œæœ‰æ­ŒåŠ‡é™¢' },
        { name: 'å½°åŒ–ç¸£', type: 'city', price: 1000, rent: 200, desc: 'å…«å¦å±±å¤§ä½›ï¼ŒèŠ±å‰æ•…é„‰' },
        { name: 'å—æŠ•ç¸£', type: 'city', price: 1200, rent: 250, desc: 'å”¯ä¸€ä¸é æµ·ï¼Œæœ‰æ—¥æœˆæ½­' },
        { name: 'é›²æ—ç¸£', type: 'city', price: 800, rent: 150, desc: 'è¾²æ¥­å¤§ç¸£ï¼Œå¸ƒè¢‹æˆ²æ•…é„‰' },
        { name: 'ä¼‘æ¯ç«™', type: 'jail', price: 0 }, // ç¬¬10æ ¼
        { name: 'å˜‰ç¾©å¸‚', type: 'city', price: 1000, rent: 200, desc: 'ç«é›è‚‰é£¯ï¼Œç®¡æ¨‚ä¹‹éƒ½' },
        { name: 'å°å—å¸‚', type: 'city', price: 1600, rent: 350, desc: 'å¤è¹Ÿæœ€å¤šï¼Œç¾é£Ÿä¹‹éƒ½' },
        { name: 'é«˜é›„å¸‚', type: 'city', price: 1800, rent: 400, desc: 'æ¸¯éƒ½ï¼Œæœ‰85å¤§æ¨“èˆ‡é§äºŒ' },
        { name: 'å±æ±ç¸£', type: 'city', price: 1200, rent: 250, desc: 'å°ç£æœ€å—ç«¯ï¼Œå¢¾ä¸å¤§è¡—' },
        { name: 'æ©Ÿæœƒ',    type: 'chance', price: 0 },
        { name: 'å°æ±ç¸£', type: 'city', price: 1000, rent: 200, desc: 'ç†±æ°£çƒå˜‰å¹´è¯ï¼Œé‡‹è¿¦å¥½' },
        { name: 'èŠ±è“®ç¸£', type: 'city', price: 1200, rent: 250, desc: 'å¤ªé­¯é–£å³½è°·ï¼Œç‘ç©—ç‰§å ´' },
        { name: 'å®œè˜­ç¸£', type: 'city', price: 1000, rent: 200, desc: 'ä¸‰æ˜Ÿè”¥ï¼Œç¤æºªæº«æ³‰' },
        { name: 'åŸºéš†å¸‚', type: 'city', price: 800, rent: 150, desc: 'é›¨éƒ½ï¼Œå»Ÿå£å¤œå¸‚é¼é‚ŠéŠ¼' }
    ];

    // é¡Œåº« (å¯è‡ªè¡Œæ“´å……)
    const questions = [
        { q: "è«‹å•ã€Œé¢¨åŸã€æ˜¯å“ªå€‹åŸå¸‚çš„åˆ¥ç¨±ï¼Ÿ", opts: ["å°åŒ—å¸‚", "æ–°ç«¹å¸‚", "åŸºéš†å¸‚", "é«˜é›„å¸‚"], ans: 1 },
        { q: "å°ç£æœ€é«˜çš„å±±ã€Œç‰å±±ã€ä½æ–¼å—æŠ•ç¸£èˆ‡å“ªè£¡çš„äº¤ç•Œï¼Ÿ", opts: ["å˜‰ç¾©ç¸£", "èŠ±è“®ç¸£", "å®œè˜­ç¸£", "å°ä¸­å¸‚"], ans: 0 },
        { q: "å“ªä¸€å€‹ç¸£å¸‚ä»¥ã€Œä¸‰æ˜Ÿè”¥ã€èåï¼Ÿ", opts: ["å±æ±ç¸£", "å®œè˜­ç¸£", "å½°åŒ–ç¸£", "å°æ±ç¸£"], ans: 1 },
        { q: "è‘—åçš„ã€Œå¤ªé­¯é–£åœ‹å®¶å…¬åœ’ã€ä½æ–¼å“ªè£¡ï¼Ÿ", opts: ["èŠ±è“®ç¸£", "å°æ±ç¸£", "å—æŠ•ç¸£", "å°åŒ—å¸‚"], ans: 0 },
        { q: "å°ç£å”¯ä¸€ä¸é æµ·çš„ç¸£å¸‚æ˜¯ï¼Ÿ", opts: ["å˜‰ç¾©ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "è‹—æ —ç¸£"], ans: 1 },
        { q: "è«‹å•ã€Œèµ¤å´æ¨“ã€èˆ‡ã€Œå®‰å¹³å¤å ¡ã€ä½æ–¼ï¼Ÿ", opts: ["æ–°åŒ—å¸‚", "å°ä¸­å¸‚", "å°å—å¸‚", "é«˜é›„å¸‚"], ans: 2 },
        { q: "æ¯åˆ°ä¹æœˆæœƒå¹èµ·å¼·å‹çš„ã€Œä¹é™é¢¨ã€æ˜¯åœ¨å“ªè£¡ï¼Ÿ", opts: ["å±æ±", "æ–°ç«¹", "åŸºéš†", "æ·¡æ°´"], ans: 1 },
        { q: "è‘—åçš„ã€Œå¢¾ä¸åœ‹å®¶å…¬åœ’ã€ä½æ–¼å“ªå€‹ç¸£å¸‚ï¼Ÿ", opts: ["é«˜é›„å¸‚", "å±æ±ç¸£", "å°æ±ç¸£", "èŠ±è“®ç¸£"], ans: 1 },
        { q: "å“ªå€‹åŸå¸‚è¢«ç¨±ç‚ºã€Œé›¨éƒ½ã€ï¼Ÿ", opts: ["å°åŒ—å¸‚", "åŸºéš†å¸‚", "å®œè˜­ç¸£", "æ–°åŒ—å¸‚"], ans: 1 },
        { q: "å°ç£æœ€å¤§çš„åœ‹éš›æ©Ÿå ´ä½æ–¼ï¼Ÿ", opts: ["å°åŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "é«˜é›„å¸‚"], ans: 2 }
    ];

    // ç©å®¶åˆå§‹è³‡æ–™
    const players = [
        { id: 0, name: 'ç©å®¶1', color: 'var(--p1-color)', money: 20000, pos: 0, stop: 0 },
        { id: 1, name: 'ç©å®¶2', color: 'var(--p2-color)', money: 20000, pos: 0, stop: 0 },
        { id: 2, name: 'ç©å®¶3', color: 'var(--p3-color)', money: 20000, pos: 0, stop: 0 },
        { id: 3, name: 'ç©å®¶4', color: 'var(--p4-color)', money: 20000, pos: 0, stop: 0 }
    ];

    let currentTurn = 0; // 0~3
    let landOwners = Array(mapData.length).fill(null); // ç´€éŒ„åœ°ä¸» ID

    // --- åˆå§‹åŒ–ç¨‹å¼ ---
    
    function initGame() {
        const boardEl = document.getElementById('board');
        
        // ä¾æ“šé †åºå°‡æ ¼å­æ’å…¥ CSS Grid (6x6 å¤–åœˆ)
        // é †åºï¼šä¸Šæ’(å·¦åˆ°å³) -> å³æ’(ä¸Šåˆ°ä¸‹) -> ä¸‹æ’(å³åˆ°å·¦) -> å·¦æ’(ä¸‹åˆ°ä¸Š)
        mapData.forEach((data, i) => {
            let cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}`; // çµ¦æ¯å€‹æ ¼å­ç¨ç«‹ ID

            // è™•ç†ç‰¹æ®Šæ ¼å­æ¨£å¼
            if(data.type === 'start') cell.classList.add('type-start');
            if(data.type === 'chance') cell.classList.add('type-chance');
            if(data.type === 'jail') cell.classList.add('type-jail');

            // è¨ˆç®— Grid ä½ç½®
            let r, c;
            if(i < 6) { r = 1; c = i + 1; } // Top
            else if(i < 10) { r = i - 4; c = 6; } // Right
            else if(i < 16) { r = 6; c = 6 - (i - 10); } // Bottom
            else { r = 6 - (i - 15); c = 1; } // Left
            
            cell.style.gridRow = r;
            cell.style.gridColumn = c;

            // é¡¯ç¤ºæ–‡å­—
            let priceText = data.price > 0 ? `$${data.price}` : '';
            cell.innerHTML = `
                <div class="cell-name">${data.name}</div>
                <div class="cell-price">${priceText}</div>
                <div class="players-container" id="players-in-${i}"></div>
            `;
            boardEl.appendChild(cell);
        });

        drawPlayers();
        updateUI();
    }

    // ç¹ªè£½æ£‹å­
    function drawPlayers() {
        // å…ˆæ¸…ç©ºæ‰€æœ‰æ ¼å­çš„æ£‹å­å®¹å™¨
        for(let i=0; i<mapData.length; i++) {
            document.getElementById(`players-in-${i}`).innerHTML = '';
        }
        // é‡æ–°æ”¾ç½®
        players.forEach(p => {
            let container = document.getElementById(`players-in-${p.pos}`);
            let token = document.createElement('div');
            token.className = 'token';
            token.style.backgroundColor = p.color;
            container.appendChild(token);
        });
    }

    // æ›´æ–° UI ä»‹é¢ (é‡‘éŒ¢ã€ç‹€æ…‹ã€åœ°ç”¢åˆ—è¡¨)
    function updateUI() {
        players.forEach((p, i) => {
            // é‡‘éŒ¢
            document.getElementById(`p${i+1}-money`).innerText = p.money;
            
            // è¼ªåˆ°èª°ï¼ŒåŠ äº®é‚Šæ¡†
            let infoBox = document.getElementById(`p${i+1}-info`);
            if (i === currentTurn) infoBox.classList.add('active-turn');
            else infoBox.classList.remove('active-turn');

            // æ›´æ–°åœ°ç”¢åˆ—è¡¨æ–‡å­—
            updateLandList(i);
        });
    }

    // æ›´æ–°æŸä½ç©å®¶çš„åœ°ç”¢åˆ—è¡¨æ–‡å­—
    function updateLandList(playerId) {
        let lands = [];
        landOwners.forEach((owner, idx) => {
            if (owner === playerId) {
                lands.push(mapData[idx].name);
            }
        });
        
        let text = lands.length > 0 ? "åœ°ç”¢: " + lands.join("ã€") : "åœ°ç”¢: ç„¡";
        document.getElementById(`p${playerId+1}-lands`).innerText = text;
    }

    function log(msg) {
        let logEl = document.getElementById('message-log');
        let div = document.createElement('div');
        div.innerText = msg;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- éŠæˆ²é‚è¼¯ ---

    function rollDice() {
        let btn = document.getElementById('dice-btn');
        btn.disabled = true;
        
        let p = players[currentTurn];

        // æª¢æŸ¥æ˜¯å¦æš«åœ
        if (p.stop > 0) {
            p.stop--;
            log(`${p.name} æš«åœä¸­ (å‰© ${p.stop} å›åˆ)`);
            setTimeout(nextTurn, 1000);
            return;
        }

        // éª°å­å‹•ç•«
        let steps = Math.floor(Math.random() * 6) + 1;
        let display = document.getElementById('dice-display');
        let count = 0;
        let anim = setInterval(() => {
            display.innerText = "ğŸ² " + (Math.floor(Math.random()*6)+1);
            count++;
            if(count > 10) {
                clearInterval(anim);
                display.innerText = "ğŸ² " + steps;
                log(`${p.name} æ“²å‡ºäº† ${steps} é»`);
                movePlayer(p, steps);
            }
        }, 50);
    }

    function movePlayer(p, steps) {
        let currentStep = 0;
        let interval = setInterval(() => {
            p.pos++;
            if(p.pos >= mapData.length) {
                p.pos = 0; // å›åˆ°èµ·é»
                p.money += 500;
                log(`${p.name} ç¶“éèµ·é»ï¼Œçå‹µ $500`);
            }
            drawPlayers();
            currentStep++;

            if(currentStep >= steps) {
                clearInterval(interval);
                handleEvent(p); // è™•ç†åœç•™äº‹ä»¶
            }
        }, 300);
    }

    function handleEvent(p) {
        let cell = mapData[p.pos];
        
        // 1. ç‰¹æ®Šæ ¼å­
        if(cell.type === 'start') {
            nextTurn();
        } else if(cell.type === 'jail') {
            log(`${p.name} é€²å…¥ä¼‘æ¯ç«™ï¼Œæš«åœä¸€å›åˆ`);
            p.stop = 1;
            nextTurn();
        } else if(cell.type === 'chance') {
            triggerChance(p);
        } else if(cell.type === 'city') {
            // 2. åŸå¸‚æ ¼å­
            let owner = landOwners[p.pos];
            if(owner === null) {
                // ç„¡äººåœ° -> å•æ˜¯å¦è³¼è²·
                askToBuy(p, cell);
            } else if(owner === p.id) {
                // è‡ªå·±åœ°
                log(`${p.name} å›åˆ°è‡ªå·±çš„åœ°ç›¤ ${cell.name}`);
                nextTurn();
            } else {
                // åˆ¥äººåœ° -> ä»˜éè·¯è²»
                payRent(p, owner, cell);
            }
        }
    }

    // æ©Ÿæœƒå‘½é‹
    function triggerChance(p) {
        const events = [
            { t: "ä¸­çç™¼ç¥¨", m: 500, txt: "é‹æ°£çœŸå¥½ï¼Œç²å¾— $500" },
            { t: "è¶…é€Ÿç½°å–®", m: -300, txt: "è¢«æ‹ç…§äº†ï¼Œæ”¯ä»˜ $300" },
            { t: "æ’¿åˆ°éŒ¢", m: 200, txt: "è·¯ä¸Šæ’¿åˆ° $200" },
            { t: "è«‹å®¢å–é£²æ–™", m: -100, txt: "è«‹å¤§å®¶å–é£²æ–™ï¼ŒèŠ±è²» $100" }
        ];
        let ev = events[Math.floor(Math.random() * events.length)];
        
        showModal("æ©Ÿæœƒ/å‘½é‹", ev.txt, ["ç¢ºå®š"], () => {
            p.money += ev.m;
            updateUI();
            checkBankrupt(p);
            nextTurn();
        });
    }

    // æ”¯ä»˜éè·¯è²»
    function payRent(p, ownerId, cell) {
        let rent = cell.rent;
        let ownerName = players[ownerId].name;
        
        log(`${p.name} è¸©åˆ° ${ownerName} çš„åœ°ï¼Œä»˜éè·¯è²» $${rent}`);
        p.money -= rent;
        players[ownerId].money += rent;
        
        updateUI();
        checkBankrupt(p);
        nextTurn();
    }

    // è©¢å•è³¼è²·
    function askToBuy(p, cell) {
        if(p.money < cell.price) {
            log(`${p.name} æƒ³è²· ${cell.name} ä½†éŒ¢ä¸å¤  (éœ€ $${cell.price})`);
            nextTurn();
            return;
        }

        showModal(`è³¼è²·åœ°ç”¢ï¼š${cell.name}`, 
            `åƒ¹æ ¼: $${cell.price}\nä»‹ç´¹: ${cell.desc}\n\nå›ç­”æ­£ç¢ºå³å¯è³¼è²·ï¼`, 
            ["æŒ‘æˆ°é¡Œç›®", "æ”¾æ£„"], 
            (idx) => {
                if(idx === 0) runQuiz(p, cell);
                else {
                    log(`${p.name} æ”¾æ£„è³¼è²· ${cell.name}`);
                    nextTurn();
                }
            }
        );
    }

    // åŸ·è¡Œå•ç­”
    function runQuiz(p, cell) {
        let q = questions[Math.floor(Math.random() * questions.length)];
        
        // è¨­å®šå½ˆçª—å…§å®¹
        let titleEl = document.getElementById('modal-title');
        let descEl = document.getElementById('modal-desc');
        let optsEl = document.getElementById('modal-options');
        let overlay = document.getElementById('modal-overlay');

        titleEl.innerText = "åœ°ç†å¤§æŒ‘æˆ°";
        descEl.innerText = q.q;
        optsEl.innerHTML = '';

        q.opts.forEach((optText, i) => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = optText;
            btn.onclick = () => {
                // é—œé–‰è¦–çª—
                overlay.style.display = 'none';
                
                if(i === q.ans) {
                    // ç­”å°
                    log(`ç­”å°äº†ï¼${p.name} è²·ä¸‹äº† ${cell.name}`);
                    buyLand(p, cell);
                } else {
                    // ç­”éŒ¯
                    log(`${p.name} ç­”éŒ¯äº†ï¼Œè³¼è²·å¤±æ•—ï¼`);
                }
                nextTurn();
            };
            optsEl.appendChild(btn);
        });

        overlay.style.display = 'flex';
    }

    // å¯¦éš›åŸ·è¡Œè²·åœ°å‹•ä½œ (è³‡æ–™æ›´æ–° + è¦–è¦ºè®Šè‰²)
    function buyLand(p, cell) {
        p.money -= cell.price;
        landOwners[p.pos] = p.id;

        // è¦–è¦ºè®Šè‰²ï¼šæŠ“å–æ ¼å­ DOM
        let cellEl = document.getElementById(`cell-${p.pos}`);
        cellEl.style.border = `4px solid ${p.color}`; // è®Šç²—æ¡†
        cellEl.style.backgroundColor = p.color.replace('rgb', 'rgba').replace(')', ', 0.15)'); // è®Šæ·¡èƒŒæ™¯
        
        // è‹¥ä½¿ç”¨ hex é¡è‰²ç¢¼ï¼Œé€™è£¡ç°¡å–®è™•ç†ç›´æ¥æ”¹ border å³å¯ï¼ŒèƒŒæ™¯è‰²é¸ç”¨
        // ä¸Šé¢é€™è¡Œå¦‚æœé¡è‰²æ ¼å¼è¤‡é›œå¯èƒ½å¤±æ•ˆï¼Œä¸»è¦é  border

        updateUI(); // é€™æœƒè§¸ç™¼ updateLandList æ›´æ–°å³å´æ–‡å­—
    }

    // é¡¯ç¤ºé€šç”¨å½ˆçª—
    function showModal(title, desc, btnTexts, callback) {
        let overlay = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        let opts = document.getElementById('modal-options');
        opts.innerHTML = '';

        btnTexts.forEach((txt, i) => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = txt;
            btn.onclick = () => {
                overlay.style.display = 'none';
                if(callback) callback(i);
            };
            opts.appendChild(btn);
        });
        overlay.style.display = 'flex';
    }

    // æª¢æŸ¥ç ´ç”¢
    function checkBankrupt(p) {
        if(p.money < 0) {
            alert(`${p.name} ç ´ç”¢äº†ï¼éŠæˆ²çµæŸï¼`);
            location.reload(); // ç°¡å–®é‡å•Ÿ
        }
    }

    // æ›æ‰‹
    function nextTurn() {
        currentTurn = (currentTurn + 1) % 4;
        updateUI();
        document.getElementById('dice-btn').disabled = false;
        log(`æ› ${players[currentTurn].name} è¡Œå‹•`);
    }

    // --- å•Ÿå‹•éŠæˆ² ---
    initGame();

</script>
</body>

</html>

